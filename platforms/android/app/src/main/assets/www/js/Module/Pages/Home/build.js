define(["API/Search","API/Address","API/Post","API/UserAPI"],()=>({viewModel:function(){const searchAPI=require("API/Search"),addressAPI=require("API/Address"),postAPI=require("API/Post"),store=require("Store/Store"),userAPI=require("API/UserAPI");let dataChangePage=this._request.data;this.listPinID=ko.observableArray([]),this.temp=new Array(10).fill(1),this.resultSearch=ko.observableArray([]),this.listDistrict=ko.observableArray([]),this.listWards=ko.observableArray([]),this.selectedArea=ko.observable(0),this.selectedPrice=ko.observable(0),this.selectedDistrict=ko.observable({}),this.selectedWard=ko.observable({});let isSetFilter=!1;this.order=ko.observable(1),this.isShowEmpty=ko.observable(!1);let me=this;this.converterPrice=ko.pureComputed(()=>{let res={max_price:0,min_price:0};switch(this.selectedPrice()){case"1":res.max_price=1e6,res.min_price=0;break;case"2":res.max_price=2e6,res.min_price=1e6;break;case"3":res.max_price=2e6,res.min_price=5e6;break;case"4":res.max_price=1e8,res.min_price=5e6}return res}),this.converterArea=ko.pureComputed(()=>{let res={max_area:0,min_area:0};switch(this.selectedArea()){case"1":res.max_area=20,res.min_area=0;break;case"2":res.max_area=40,res.min_area=20;break;case"3":res.max_area=5e3,res.min_area=40}return res}),this.resultSearch.subscribe(function(newValue){0===newValue.length?me.isShowEmpty(!0):me.isShowEmpty(!1)});let page=0,size=2;addressAPI.getDistricts().then(res=>{let listDiscict=[{id:0,name:"Quận"}].concat(res.data);this.listDistrict(listDiscict)}).catch(e=>{console.log(e)}),this.selectedDistrict.subscribe(e=>{e?addressAPI.getWards(e).then(res=>{let listWards=[{id:0,name:"Phường"}].concat(res.data);this.listWards(listWards)}).catch(e=>{console.log(e)}):this.listWards([{id:0,name:"Phường"}])});var user_id;this.afterBinding=(()=>{cordova.plugins.firebase.messaging.onMessage(function(payload){}),cordova.plugins.firebase.messaging.onBackgroundMessage(function(payload){console.log("New background FCM message: ",payload),setTimeout(()=>{app.setPage("PostDetail",{id:payload.post_id})},1e3)}),$(window).off("scroll"),$(window).on("scroll",function(){$(".app").height()<=$("html").scrollTop()+$(window).height()+1&&page<size&&(isSetFilter?callFilter():getStartPage())}),userAPI.getInfo().then(res=>{localStorage.setItem("imageURL",res.data.avatar),localStorage.setItem("name",res.data.display_name),localStorage.setItem("email",res.data.email||""),localStorage.setItem("userId",res.data.user_id),localStorage.setItem("created_at",res.data.created_at),localStorage.setItem("phone",res.data.phone||""),localStorage.setItem("address",res.data.address||"Hồ Chí Minh"),$("com-slider img")[0].src=res.data.avatar,$("com-slider .information-user p")[0].innerHTML=window.localStorage.getItem("name"),user_id=res.data.user_id,cordova.plugins.firebase.messaging.requestPermission({forceShow:!0}).then(function(){console.log("You'll get foreground notifications when a push message arrives"),cordova.plugins.firebase.messaging.subscribe(`/topics/notification.user.${user_id}`).then(e=>{console.log(e)}).catch(e=>{console.log(e)})}).catch(e=>{})}).catch(e=>{console.log(e)})});let getStartPage=()=>{store.isShowLoading(!0),searchAPI.indexPage(page++).then(res=>{size=Math.ceil(res.data.total/10),this.resultSearch.push(...res.data.hits.map(e=>Object.assign(e,{pinned:ko.observable(!1)}))),store.isShowLoading(!1)}).catch(e=>{console.log(e),store.isShowLoading(!1)})};this.resultWithPin=ko.pureComputed(()=>{let result=this.resultSearch();return result.forEach(e=>{this.listPinID.indexOf(e.id)>-1?e.pinned(!0):e.pinned(!1)}),result}),dataChangePage?this.resultSearch(dataChangePage.map(e=>Object.assign(e,{pinned:ko.observable(!1)}))):getStartPage(),$(document).off("changeSearchResult"),$(document).on("changeSearchResult",(event,res)=>{this.resultSearch(res.data.map(e=>Object.assign(e,{pinned:ko.observable(!1)})))}),this.addFavorite=((data,event)=>{data.pinned()?postAPI.unpin(data.id).then(res=>{data.pinned(!1)}).catch(e=>console.log(e)):(event.currentTarget.getElementsByTagName("path")[0].setAttribute("fill","red"),postAPI.pin(data.id).then(res=>{res.code||app.setPage("MyPin")}).catch(e=>console.log(e)))}),postAPI.getMyPin().then(res=>{me.listPinID(res.data.hits.map(e=>e.id))}).catch(e=>{console.log(e)}),this.applyFilter=(()=>{isSetFilter=!0,page=0,this.resultSearch([]),callFilter()});let callFilter=()=>{store.isShowLoading(!0),searchAPI.filter({max_area:this.converterArea().max_area,min_area:this.converterArea().min_area,district_id:this.selectedDistrict(),max_price:this.converterPrice().max_price,min_price:this.converterPrice().min_price,ward_id:this.selectedWard(),location:document.getElementById("search").value,order:this.order()},page++).then(res=>{store.isShowLoading(!1),size=Math.ceil(res.data.total/10),this.resultSearch.push(...res.data.hits.map(e=>Object.assign(e,{pinned:ko.observable(!1)})))}).catch(e=>{console.log(e)})};this.removePopupSuccess=(()=>{store.isShowBlank(!1),$("#popup-success").removeClass("active"),this.order($("input[name='order']:checked").val())}),this.getOrder=(()=>{$(`input[value='${this.order()}']`)[0].checked=!0,$("#popup-success").addClass("active"),store.isShowBlank(!0)})},template:'\n            <div id="home-page">\n    <com-slider></com-slider>\n    <com-headercontext></com-headercontext>\n    <div class="popup success" id="popup-success">\n        <div class="title">Tiêu chí sắp xếp</div>\n        <div class="order-field">\n            <input type="radio" name="order" value="1" id="input1">\n            <label for="input1">Mới nhất</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="0" id="input0">\n            <label for="input0">Cũ nhất</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="2" id="input2">\n            <label for="input2">Giá thấp</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="3" id="input3">\n            <label for="input3">Giá cao</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="4" id="input4">\n            <label for="input4">Diện tích tăng dần</label>\n        </div>\n        <div class="order-field">\n            <input type="radio" name="order" value="5" id="input5">\n            <label for="input5">Diện tích giảm dần</label>\n        </div>\n        <button class="btn-submit" style="padding: 7px 22px;margin-top: 10px;" data-bind="event: {tap: removePopupSuccess}">OK</button>\n    </div>\n    <div class="body-content">\n        <div class="filter">\n            <select name="district_id" data-bind="\n                options: listDistrict,\n                optionsText: function(item){return item.name},\n                optionsValue: function(item){return item.id},\n                value: selectedDistrict">\n            </select>\n            <select name="ward_id" data-bind="\n                options: listWards,\n                optionsText: function(item){return item.name},\n                optionsValue: function(item){return item.id},\n                value: selectedWard">\n            </select>\n            <div class="dp-flex">\n                <select name="price-range" data-bind="value: selectedPrice">\n                    <option value="0" selected>Khoảng giá</option>\n                    <option value="1">Dưới 1.000.000</option>\n                    <option value="2">1.000.000 - 2.000.000</option>\n                    <option value="3">2.000.000 - 5.000.000</option>\n                    <option value="4">Trên 5.000.000</option>\n                </select>\n                <select name="area" data-bind="value: selectedArea">\n                    <option value="" selected>Diện tich</option>\n                    <option value="1">Dưới 20m²</option>\n                    <option value="2">Từ 20m² đên 40m²</option>\n                    <option value="3">Trên 40m²</option>\n                </select>\n            </div>\n            <div class="apply-filter">\n                <button data-bind="event: {tap: getOrder}">Sắp xếp</button>\n                <button data-bind="event: {tap: applyFilter}">Áp dụng</button>\n            </div>\n        </div>\n        <div class="empty-content" data-bind="visible: isShowEmpty">Không tìm thấy bài đăng phù hợp</div>\n\n        <div class="search-result" data-bind="foreach: resultWithPin">\n            <div class="search-item" data-bind="directInfo: {to: \'PostDetail\', data: $data}">\n                <div class="image-wrapper">\n                    <img data-bind="attr: {src: image ? image: \'./img/example.jpg\'}">\n                </div>\n                <div class="content-wrapper">\n                    <div class="content-title" data-bind="text: title"></div>\n                    <div class="content-bottom">\n                        <div class="content-price">\n                            <div class="price" data-bind="convertMoney: price"></div>\n                            <svg data-bind="event: {tap: $root.addFavorite}" xmlns="http://www.w3.org/2000/svg"\n                                width="21.828" height="20" viewBox="0 0 21.828 20">\n                                <path id="Path_1261" data-name="Path 1261"\n                                    d="M-618.345,1377.831c-.575-.558-1.109-1.06-1.625-1.58q-3.687-3.721-7.368-7.448a6.558,6.558,0,0,1-1.941-4.061,6.264,6.264,0,0,1,4.657-6.639,6.275,6.275,0,0,1,5.984,1.513c.055.049.112.1.177.152.137-.125.261-.248.4-.358a6.182,6.182,0,0,1,6.3-1.184,6.082,6.082,0,0,1,4.178,4.933,6.162,6.162,0,0,1-1.813,5.664c-1.681,1.7-3.381,3.385-5.072,5.077q-1.865,1.865-3.729,3.732A1.182,1.182,0,0,0-618.345,1377.831Zm-.131-15.77c-.42-.43-.8-.86-1.226-1.248a4.633,4.633,0,0,0-4.388-1.2,4.71,4.71,0,0,0-2.439,7.7c.456.53.928,1.049,1.421,1.545q3.251,3.271,6.519,6.526c.057.057.118.108.19.173.642-.644,1.271-1.275,1.9-1.9,1.985-1.986,3.977-3.966,5.954-5.96a4.681,4.681,0,0,0,1.308-4.631,4.777,4.777,0,0,0-4.741-3.623,4.792,4.792,0,0,0-3.315,1.421C-617.684,1361.252-618.065,1361.647-618.475,1362.061Z"\n                                    transform="translate(629.311 -1357.831)"\n                                    data-bind="style: {fill: pinned() ? \'red\': \'#8c8c8c\'}" />\n                            </svg>\n                        </div>\n                        <div class="content-description">\n                            <span data-bind="convertTime: created_at"></span>\n                            <span data-bind="text: location" class="location"></span>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</div>\n        '}));